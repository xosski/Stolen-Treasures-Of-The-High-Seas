import logging
import json
from flask import Flask, jsonify, request, render_template_string, make_response

app = Flask(__name__)

# Настройка логирования
logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')

# Пример данных для /registry/tables
registry_datamart_tables = [
    {
        "id": "1",
        "datamart_version_id": "v1",
        "organisation": {
            "id": "org1",
            "name": "Организация 1",
            "ogrn": "1234567890123",
            "orgTypeId": "type1"
        },
        "mnemonic": "table1_mnemonic",
        "description": "Описание таблицы 1",
        "name": "Таблица 1",
        "table_tech_name": "table_tech_1",
        "registered_at": "2023-10-21T14:30:00",
        "modified_at": "2023-12-12T09:00:00",
        "deregistered_at": "2024-08-12T12:50:00"
    },
    {
        "id": "2",
        "datamart_version_id": "v2",
        "organisation": {
            "id": "org2",
            "name": "Организация 2",
            "ogrn": "1234567890124",
            "orgTypeId": "type2"
        },
        "mnemonic": "table2_mnemonic",
        "description": "Описание таблицы 2",
        "name": "Таблица 2",
        "table_tech_name": "table_tech_2",
        "registered_at": "2023-11-11T14:30:00",
        "modified_at": "2023-12-15T09:00:00",
        "deregistered_at": ""
    }
]

# Пример данных для /quality/incidents
quality_incidents = [
    {
        "id": "incident_1",
        "subject": "Инцидент качества данных 1",
        "incident_kind": "Ошибка данных",
        "ogrn": "1234567890123",
        "datamart": {
            "id": "datamart1",
            "mnemonic": "dm1_mnemonic",
            "version_code": "v1"
        },
        "table_tech_name": "tech_table_1",
        "check_id": "check1",
        "kind": {"code": "QC1", "name": "Вид проверки 1"},
        "type": "Синтаксическая проверка",
        "acceptable_error_rate": 25,
        "error_rate": 30,
        "state": "Открыт",
        "registered_at": "2023-10-21T14:30:00",
        "resolution_deadline": "2023-10-27T14:30:00",
        "is_expired": False,
        "modified_at": "2023-12-12T09:00:00"
    },
    {
        "id": "incident_2",
        "subject": "Инцидент качества данных 2",
        "incident_kind": "Потеря данных",
        "ogrn": "1234567890124",
        "datamart": {
            "id": "datamart2",
            "mnemonic": "dm2_mnemonic",
            "version_code": "v2"
        },
        "table_tech_name": "tech_table_2",
        "check_id": "check2",
        "kind": {"code": "QC2", "name": "Вид проверки 2"},
        "type": "Логическая проверка",
        "acceptable_error_rate": 20,
        "error_rate": 50,
        "state": "Закрыт",
        "registered_at": "2023-11-01T14:30:00",
        "resolution_deadline": "2023-11-10T14:30:00",
        "is_expired": True,
        "modified_at": "2023-12-20T09:00:00"
    }
]

# Пример данных для /transactional/podd_status_logs
podd_status_logs = [
    {
        "id": "log1",
        "mnemonic": "podd_mnemonic_1",
        "organisation": {
            "id": "org1",
            "name": "Организация 1",
            "ogrn": "1234567890123",
            "orgTypeId": "type1"
        },
        "industry": {
            "id": "ind1",
            "name": "Отрасль 1",
            "code": "IND001"
        },
        "is_replicated": False,
        "is_archived": False,
        "status": "Доступна",
        "registered_at": "2023-10-21T14:30:00",
        "status_code": "200",
        "error_message": ""
    },
    {
        "id": "log2",
        "mnemonic": "podd_mnemonic_2",
        "organisation": {
            "id": "org2",
            "name": "Организация 2",
            "ogrn": "1234567890124",
            "orgTypeId": "type2"
        },
        "industry": {
            "id": "ind2",
            "name": "Отрасль 2",
            "code": "IND002"
        },
        "is_replicated": True,
        "is_archived": True,
        "status": "Недоступна",
        "registered_at": "2023-11-01T14:30:00",
        "status_code": "500",
        "error_message": "Ошибка соединения"
    }
]

# Логирование входящих запросов
@app.before_request
def log_request_info():
    logging.info(f"Incoming request: {request.method} {request.url}")
    logging.info(f"Headers: {dict(request.headers)}")
    if request.method in ['POST', 'PUT', 'PATCH']:
        logging.info(f"Body: {request.get_data(as_text=True)}")

# Логирование исходящих ответов
@app.after_request
def log_response_info(response):
    logging.info(f"Outgoing response: {response.status}")
    logging.info(f"Headers: {dict(response.headers)}")
    return response

# Эндпоинт для /registry/tables
@app.route('/registry/tables', methods=['GET'])
def get_registry_tables():
    response = make_response(json.dumps(registry_datamart_tables, ensure_ascii=False))
    response.headers['Content-Type'] = 'application/json; charset=utf-8'
    response.status_code = 200
    return response

# Эндпоинт для /quality/incidents
@app.route('/quality/incidents', methods=['GET'])
def get_quality_incidents():
    response = make_response(json.dumps(quality_incidents, ensure_ascii=False))
    response.headers['Content-Type'] = 'application/json; charset=utf-8'
    response.status_code = 200
    return response

# Эндпоинт для /transactional/podd_status_logs
@app.route('/transactional/podd_status_logs', methods=['GET'])
def get_podd_status_logs():
    response = make_response(json.dumps(podd_status_logs, ensure_ascii=False))
    response.headers['Content-Type'] = 'application/json; charset=utf-8'
    response.status_code = 200
    return response

# Эндпоинт для проверки статуса сервера
@app.route('/status', methods=['GET'])
def status():
    response = make_response(json.dumps({"status": "running", "message": "Сервер запущен и работает корректно"}, ensure_ascii=False))
    response.headers['Content-Type'] = 'application/json; charset=utf-8'
    return response

# Главная страница с HTML-формой для проверки эндпоинтов
@app.route('/')
def home():
    html_content = '''
    <html>
    <head>
        <title>API Server Status</title>
    </head>
    <body>
        <h1>API Server Status</h1>
        <p>Сервер запущен и работает. Ниже приведены ссылки для проверки эндпоинтов:</p>
        <ul>
            <li><a href="/status" target="_blank">Проверить статус сервера (/status)</a></li>
            <li><a href="/registry/tables" target="_blank">Получить данные о таблицах витрин (/registry/tables)</a></li>
            <li><a href="/quality/incidents" target="_blank">Получить данные об инцидентах качества данных (/quality/incidents)</a></li>
            <li><a href="/transactional/podd_status_logs" target="_blank">Получить данные о статусе доступности витрин (/transactional/podd_status_logs)</a></li>
        </ul>
    </body>
    </html>
    '''
    return render_template_string(html_content)

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=8080)
